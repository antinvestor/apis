name: Publish Dart Packages

on:
  push:
    tags:
      - "dart/*/v*.*.*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Setup pub credentials
        run: |
          mkdir -p ~/.config/dart
          echo '${{ secrets.PUB_DEV_CREDENTIALS }}' > ~/.config/dart/pub-credentials.json

      - name: Release package
        run: |
          VERSION_NO="${{github.ref_name}}"
          PACKAGE="${{ matrix.package }}"
          PACKAGE_DIR="dart/$PACKAGE"
          
          echo "================================================"
          echo "Processing package: $PACKAGE"
          echo "================================================"
          
          if [ ! -d "$PACKAGE_DIR" ]; then
            echo "  Package directory not found: $PACKAGE_DIR"
            exit 1
          fi
          
          cd "$PACKAGE_DIR"
          
          # Get package name
          PACKAGE_NAME=$(grep '^name:' pubspec.yaml | sed 's/name: //')
          echo "Package name: $PACKAGE_NAME"
          
          # Extract version from global tag (format: vX.Y.Z)
          TAG_NAME="$VERSION_NO"
          if [[ "$TAG_NAME" =~ ^dart/([^/]+)/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            NEW_VERSION="${BASH_REMATCH[2]}"
            echo "Release version from tag: $NEW_VERSION"
          else
            echo "❌ Could not parse version from tag: $TAG_NAME"
            echo "Expected format: vX.Y.Z (e.g., v1.47.0)"
            exit 1
          fi
          
          # Install dependencies
          echo "Installing dependencies..."
          dart pub get
          
          # Run analysis
          echo "Running dart analyze..."
          dart analyze
          
          # Dry run publish
          echo "Running dry-run publish..."
          dart pub publish --dry-run
          
          # Publish to pub.dev
          echo "Publishing to pub.dev..."
          dart pub publish --force
          
          echo "✅ Successfully published $PACKAGE v$NEW_VERSION"
