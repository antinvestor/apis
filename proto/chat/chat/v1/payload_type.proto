// Copyright 2023-2026 Ant Investor Ltd
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package chat.v1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";

option go_package = "github.com/antinvestor/apis/go/chat/v1;chatv1";
option java_multiple_files = true;
option java_package = "chatv1";

// Allowed message types. Extendable via new enum values; clients must ignore unknown values.
enum PayloadType {
  PAYLOAD_TYPE_UNSPECIFIED = 0;
  PAYLOAD_TYPE_ROOM_CHANGE = 1;
  PAYLOAD_TYPE_TEXT = 2;
  PAYLOAD_TYPE_ATTACHMENT = 3;
  PAYLOAD_TYPE_REACTION = 7;
  PAYLOAD_TYPE_ENCRYPTED = 6; // opaque ciphertext
  PAYLOAD_TYPE_CALL = 20;
  PAYLOAD_TYPE_MODERATION = 21;
  PAYLOAD_TYPE_MOTION = 22;
  PAYLOAD_TYPE_VOTE = 23;
  PAYLOAD_TYPE_MOTION_TALLY = 24;
  PAYLOAD_TYPE_VOTE_TALLY = 25;
}

enum RoomChangeAction {
  ROOM_CHANGE_ACTION_UNSPECIFIED = 0;
  ROOM_CHANGE_ACTION_CREATED = 1;
  ROOM_CHANGE_ACTION_UPDATED = 2;
  ROOM_CHANGE_ACTION_DELETED = 3;
  ROOM_CHANGE_ACTION_MEMBER_ADDED = 4;
  ROOM_CHANGE_ACTION_MEMBER_REMOVED = 5;
  ROOM_CHANGE_ACTION_ROLE_CHANGED = 6;
}

message RoomChangeContent {
  RoomChangeAction action = 1;
  string actor_subscription_id = 2;
  repeated string target_subscription_ids = 3;

  // Human-readable summary (server-generated, for display)
  string body = 4;

  // Optional structured detail (depends on action)
  google.protobuf.Struct details = 5;
}

message ModerationContent {
  // Human-readable message body describing the action.
  // Intended for display to end users.
  string body = 1 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 10000
  ];

  // Subscription ID of the actor who initiated the action.
  string actor_subscription_id = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 32
  ];

  // Subscription IDs of entities targeted by the action.
  // Must not contain duplicates and must not include the actor.
  repeated string target_subscription_ids = 3 [
    (buf.validate.field).repeated.unique = true,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 3
        max_len: 40
        pattern: "[0-9a-z_-]{3,40}"
      }
    }
  ];

  // Optional structured metadata associated with the action.
  // Use only for non-indexed, auxiliary data.
  google.protobuf.Struct metadata = 8;

  // Optional language tag for the body, using BCP-47 (e.g. "en", "fr-CA").
  optional string language = 4 [(buf.validate.field).string.pattern = "^[a-zA-Z]{2,3}(-[a-zA-Z0-9]{2,8})*$"];
}

message TextContent {
  // Required human-readable message body
  string body = 1 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 10000
  ];

  // Content format identifier (NOT MIME type)
  // Examples: "plain", "markdown", "html-lite"
  string format = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 32
  ];

  // Structured annotations for clients (mentions, links, emojis)
  repeated TextAnnotation annotations = 3;

  // Optional language hint (BCP-47), e.g. "en", "fr-CA"
  optional string lang = 4;
}

message TextAnnotation {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    TYPE_MENTION_USER = 1;
    TYPE_MENTION_ROOM = 2;
    TYPE_LINK = 3;
    TYPE_EMOJI = 4;
    TYPE_HASHTAG = 5;
  }

  Type type = 1;

  // UTF-16 offset & length for cross-platform compatibility
  int32 offset = 2;
  int32 length = 3;

  // Target identifier (e.g., profile_id, room_id, URL)
  string value = 4;
}

message AttachmentContent {
  // Logical identifier of the attachment
  string attachment_id = 1;

  // Original filename (optional, user-facing)
  string filename = 2;

  // MIME type (e.g. image/png, application/pdf)
  string mime_type = 3;

  // Size in bytes (for quota enforcement & UX)
  int64 size_bytes = 4;

  // Content location (signed URL or opaque locator)
  string uri = 5;

  // Optional previews / thumbnails
  repeated AttachmentPreview previews = 6;

  // Optional caption text
  optional TextContent caption = 7;

  // Indicates whether attachment is end-to-end encrypted
  bool encrypted = 8;

  // Optional content hash (e.g. sha256:base64)
  optional string checksum = 9;
}

message AttachmentPreview {
  string mime_type = 1;
  int32 width = 2;
  int32 height = 3;
  string uri = 4;
  int64 size_bytes = 5;
}

message ReactionContent {
  // Target message being reacted to
  string target_event_id = 1 [(buf.validate.field).string.min_len = 3];

  // Reaction key (e.g. ðŸ‘, â¤ï¸, :custom_emoji:)
  string reaction = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 64
  ];

  // add=true â†’ ensure reaction exists
  // add=false â†’ ensure reaction does not exist
  bool add = 3;
}

message EncryptedContent {
  // Encryption scheme identifier
  // Examples: "olm.v2", "megolm.v1", "x25519-aesgcm"
  string algorithm = 1;

  // Base64 or binary-safe encoded ciphertext
  bytes ciphertext = 2;

  // Optional per-message nonce / IV
  optional bytes nonce = 3;

  // Optional sender key identifier
  optional string sender_key_id = 4;

  // Optional recipient key references (for fan-out)
  repeated string recipient_key_ids = 5;

  // Additional authenticated data (AAD)
  optional bytes aad = 6;

  // Optional key agreement context identifier
  optional string session_id = 7;
}

message CallContent {
  enum CallType {
    CALL_TYPE_UNSPECIFIED = 0;
    CALL_TYPE_AUDIO = 1;
    CALL_TYPE_VIDEO = 2;
    CALL_TYPE_SCREEN_SHARE = 3;
  }

  enum CallAction {
    CALL_ACTION_UNSPECIFIED = 0;
    CALL_ACTION_OFFER = 1;
    CALL_ACTION_ANSWER = 2;
    CALL_ACTION_ICE_CANDIDATE = 3;
    CALL_ACTION_END = 4;
  }

  string call_id = 1;
  CallType type = 2;

  // OFFER, ANSWER â†’ sdp required
  // ICE_CANDIDATE â†’ ice_candidate required
  // END â†’ no payload required
  CallAction action = 3;

  // WebRTC payload (SDP or ICE candidate)
  optional string sdp = 4;

  // Optional ICE candidate (when action = ICE_CANDIDATE)
  optional string ice_candidate = 5;

  // Optional metadata (bitrate, codecs, device hints)
  google.protobuf.Struct metadata = 8;
}

message MotionContent {
  string id = 1;

  // Human-readable description
  string title = 2;
  string description = 3;

  // Roles allowed to vote; eligible_votes is derived
  repeated string eligible_roles = 13;

  // Snapshot of eligible voters at creation time (optional, cached)
  optional uint32 eligible_votes = 4;

  // Number of votes required to pass
  // Can represent absolute count or percentage thresholds
  // Passing rule
  PassingRule passing_rule = 7;

  // Available choices (YES / NO / ABSTAIN, etc)
  repeated VoteChoice choices = 8;

  // Optional deadline (unix seconds)
  optional int64 closes_at = 12;
}

message VoteChoice {
  string id = 1;
  string name = 2;
  optional string description = 3;
}

message PassingRule {
  oneof rule {
    // Absolute number of votes required
    uint32 absolute = 1;

    // Percentage required to pass (0â€“100)
    uint32 percentage = 2;
  }

  // Which choice constitutes "passing" (usually YES)
  string passing_choice_id = 3;
}

//    total_votes_cast = sum(choice counts excluding invalid if configured)
//    remaining_votes  = eligible_votes - total_votes_cast
//    dead_votes       = tally(choice_id == "invalid")
//    target_votes     = derived from PassingRule
//    passed           = tally(passing_choice_id) >= target_votes
message VoteCast {
  string motion_id = 1;

  // Selected choice
  string choice_id = 2;
}

message VoteTally {
  string choice_id = 1;
  uint32 count = 2;
}

message MotionTally {
  string motion_id = 1;

  // Total eligible voters
  uint32 eligible_votes = 2;

  // Votes per choice
  repeated VoteTally tallies = 3;

  // Derived counts
  uint32 total_votes_cast = 4;

  // Dead votes (invalid, expired, disqualified)
  uint32 dead_votes = 6;

  // Passing evaluation
  uint32 target_votes = 7;
  bool passed = 8;
  bool closed = 9;
}

message Payload {
  // The `type` MUST correspond to the populated payload.
  // Servers MUST reject mismatches.
  PayloadType type = 1;

  oneof data {
    // type = PAYLOAD_TYPE_UNSPECIFIED
    google.protobuf.Struct default = 7;

    // type = PAYLOAD_TYPE_ROOM_CHANGE
    RoomChangeContent room_change = 8;

    // type = PAYLOAD_TYPE_MODERATION
    ModerationContent moderation = 10;

    // type = PAYLOAD_TYPE_TEXT
    TextContent text = 15;

    // type = PAYLOAD_TYPE_ATTACHMENT
    AttachmentContent attachment = 16;

    // type = PAYLOAD_TYPE_REACTION
    ReactionContent reaction = 17;

    // type = PAYLOAD_TYPE_ENCRYPTED
    EncryptedContent encrypted = 18;

    // type = PAYLOAD_TYPE_CALL
    CallContent call = 19;

    // type = PAYLOAD_TYPE_MOTION
    MotionContent motion = 25;

    // type = PAYLOAD_TYPE_MOTION_TALLY
    MotionTally motion_tally = 28;

    // type = PAYLOAD_TYPE_VOTE
    VoteCast vote = 26;
    // type = PAYLOAD_TYPE_VOTE_TALLY
    VoteTally vote_tally = 29;
  }
}
