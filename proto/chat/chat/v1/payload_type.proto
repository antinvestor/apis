// Copyright 2023-2024 Ant Investor Ltd
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package chat.v1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";

option go_package = "github.com/antinvestor/apis/go/chat/v1;chatv1";
option java_multiple_files = true;
option java_package = "chatv1";

message TextContent {
  // Required human-readable message body
  string body = 1 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 10000
  ];

  // Content format identifier (NOT MIME type)
  // Examples: "plain", "markdown", "html-lite"
  string format = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 32
  ];

  // Structured annotations for clients (mentions, links, emojis)
  repeated TextAnnotation annotations = 3;

  // Optional language hint (BCP-47), e.g. "en", "fr-CA"
  optional string lang = 4;
}

message TextAnnotation {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    TYPE_MENTION_USER = 1;
    TYPE_MENTION_ROOM = 2;
    TYPE_LINK = 3;
    TYPE_EMOJI = 4;
    TYPE_HASHTAG = 5;
  }

  Type type = 1;

  // UTF-16 offset & length for cross-platform compatibility
  int32 offset = 2;
  int32 length = 3;

  // Target identifier (e.g., profile_id, room_id, URL)
  string value = 4;
}

message AttachmentContent {
  // Logical identifier of the attachment
  string attachment_id = 1;

  // Original filename (optional, user-facing)
  string filename = 2;

  // MIME type (e.g. image/png, application/pdf)
  string mime_type = 3;

  // Size in bytes (for quota enforcement & UX)
  int64 size_bytes = 4;

  // Content location (signed URL or opaque locator)
  string uri = 5;

  // Optional previews / thumbnails
  repeated AttachmentPreview previews = 6;

  // Optional caption text
  optional TextContent caption = 7;

  // Indicates whether attachment is end-to-end encrypted
  bool encrypted = 8;

  // Optional content hash (e.g. sha256:base64)
  optional string checksum = 9;
}

message AttachmentPreview {
  string mime_type = 1;
  int32 width = 2;
  int32 height = 3;
  string uri = 4;
  int64 size_bytes = 5;
}

message ReactionContent {
  // Target message being reacted to
  string target_event_id = 1 [(buf.validate.field).string.min_len = 3];

  // Reaction key (e.g. üëç, ‚ù§Ô∏è, :custom_emoji:)
  string reaction = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 64
  ];

  // add=true ‚Üí ensure reaction exists
  // add=false ‚Üí ensure reaction does not exist
  bool add = 3;
}

message EncryptedContent {
  // Encryption scheme identifier
  // Examples: "olm.v2", "megolm.v1", "x25519-aesgcm"
  string algorithm = 1;

  // Base64 or binary-safe encoded ciphertext
  bytes ciphertext = 2;

  // Optional per-message nonce / IV
  optional bytes nonce = 3;

  // Optional sender key identifier
  optional string sender_key_id = 4;

  // Optional recipient key references (for fan-out)
  repeated string recipient_key_ids = 5;

  // Additional authenticated data (AAD)
  optional bytes aad = 6;

  // Optional key agreement context identifier
  optional string session_id = 7;
}

message CallContent {
  enum CallType {
    CALL_TYPE_UNSPECIFIED = 0;
    CALL_TYPE_AUDIO = 1;
    CALL_TYPE_VIDEO = 2;
    CALL_TYPE_SCREEN_SHARE = 3;
  }

  enum CallAction {
    CALL_ACTION_UNSPECIFIED = 0;
    CALL_ACTION_OFFER = 1;
    CALL_ACTION_ANSWER = 2;
    CALL_ACTION_ICE_CANDIDATE = 3;
    CALL_ACTION_END = 4;
  }

  string call_id = 1;
  CallType type = 2;

  // OFFER, ANSWER ‚Üí sdp required
  // ICE_CANDIDATE ‚Üí ice_candidate required
  // END ‚Üí no payload required
  CallAction action = 3;

  // WebRTC payload (SDP or ICE candidate)
  optional string sdp = 4;

  // Optional ICE candidate (when action = ICE_CANDIDATE)
  optional string ice_candidate = 5;

  // Optional metadata (bitrate, codecs, device hints)
  google.protobuf.Struct metadata = 8;
}

message Payload {
  oneof data {
    // type = ROOM_EVENT_TYPE_TEXT
    TextContent text = 15;

    // type = ROOM_EVENT_TYPE_ATTACHMENT
    AttachmentContent attachment = 16;

    // type = ROOM_EVENT_TYPE_REACTION
    ReactionContent reaction = 17;

    // type = ROOM_EVENT_TYPE_ENCRYPTED
    EncryptedContent encrypted = 18;

    // type = ROOM_EVENT_TYPE_CALL
    CallContent call = 19;
  }
}
