// Copyright 2023-2024 Ant Investor Ltd
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package chat.v1;

import "buf/validate/validate.proto";
import "chat/v1/definitions.proto";
// -----------------------------------------------------
// Core notes (normative):
// - All timestamps are RFC3339 / google.protobuf.Timestamp.
// - All flows should be idempotent / accept idempotency keys where relevant.
// - Servers must enforce permission checks for each RPC (see AuthClaims below).
// -----------------------------------------------------
import "common/v1/common.proto";
import "gnostic/openapi/v3/annotations.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/antinvestor/apis/go/chat/v1;chatv1";
option java_multiple_files = true;
option java_package = "chatv1";
option (gnostic.openapi.v3.document) = {
  info: {
    title: "Chat Service"
    version: "v1.0.0"
    description: "The Chat Service provides endpoints for real-time, secure messaging between users and devices. It supports sending, receiving, and synchronizing messages across rooms, direct chats, and group conversations, with optional end-to-end encryption. The service is designed for mobile, desktop, and web clients, supporting both streaming and standard request-response operations. APIs are consistent, well-structured, and optimized for low-latency delivery, even on limited network connections."
    contact: {
      name: "Ant Investor Ltd"
      url: "https://github.com/antinvestor/service-chat"
      email: "info@antinvestor.com"
    }
    license: {
      name: "Apache License"
      url: "https://github.com/antinvestor/apis/blob/master/LICENSE"
    }
  }
  components: {
    security_schemes: {
      additional_properties: [
        {
          name: "BearerAuth"
          value: {
            security_scheme: {
              type: "http"
              scheme: "bearer"
              bearer_format: "JWT"
            }
          }
        }
      ]
    }
  }
};

// -----------------------------------------------------
// MAIN SERVICE: ChatService
// - Message ops: SendEvent (unified), GetHistory (cursor-based).
// - Room ops: create/update/manage members/roles.
// - Device & presence: register device, presence updates.
// - BotService included below for integration (service accounts).
// -----------------------------------------------------

service ChatService {
  // Send an event (unified message model). Idempotent if idempotency_key is provided.
  rpc SendEvent(SendEventRequest) returns (SendEventResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "sendEvent"
      summary: "Send an event to a room"
      description: "Sends one or more events to chat rooms. Supports text, attachments, reactions, and system messages. Idempotent when idempotency_key header is provided."
      tags: "Messages"
    };
  }

  // Fetch history for a room. Cursor-based paging (cursor = opaque server token).
  rpc GetHistory(GetHistoryRequest) returns (GetHistoryResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (gnostic.openapi.v3.operation) = {
      operation_id: "getHistory"
      summary: "Retrieve message history for a room"
      description: "Fetches paginated message history for a specified room using cursor-based navigation. Supports forward and backward pagination."
      tags: "Messages"
    };
  }

  // Room lifecycle & management
  rpc CreateRoom(CreateRoomRequest) returns (CreateRoomResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "createRoom"
      summary: "Create a new chat room"
      description: "Creates a new chat room with specified configuration. The creator is automatically added as a member with owner privileges. Supports both public and private rooms."
      tags: "Rooms"
    };
  }
  rpc SearchRooms(SearchRoomsRequest) returns (stream SearchRoomsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (gnostic.openapi.v3.operation) = {
      operation_id: "searchRooms"
      summary: "Search for chat rooms"
      description: "Searches for chat rooms matching the specified criteria. Returns a stream of matching rooms. Supports filtering by query, date range, and custom properties."
      tags: "Rooms"
    };
  }
  rpc UpdateRoom(UpdateRoomRequest) returns (UpdateRoomResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "updateRoom"
      summary: "Update a chat room"
      description: "Updates the configuration of an existing chat room including name, topic, and metadata. Only room owners and moderators can update room settings."
      tags: "Rooms"
    };
  }
  rpc DeleteRoom(DeleteRoomRequest) returns (DeleteRoomResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "deleteRoom"
      summary: "Delete a chat room"
      description: "Permanently deletes a chat room and all its messages. This action cannot be undone. Only room owners can delete rooms."
      tags: "Rooms"
    };
  }

  // Subscriptionship & roles
  rpc AddRoomSubscriptions(AddRoomSubscriptionsRequest) returns (AddRoomSubscriptionsResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "addRoomSubscriptions"
      summary: "Add members to a room"
      description: "Adds one or more users to a chat room with specified roles. The requesting user must have owner or moderator privileges in the room."
      tags: "Subscriptions"
    };
  }
  rpc RemoveRoomSubscriptions(RemoveRoomSubscriptionsRequest) returns (RemoveRoomSubscriptionsResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "removeRoomSubscriptions"
      summary: "Remove members from a room"
      description: "Removes one or more users from a chat room. The requesting user must have owner or moderator privileges in the room, unless removing themselves."
      tags: "Subscriptions"
    };
  }
  rpc UpdateSubscriptionRole(UpdateSubscriptionRoleRequest) returns (UpdateSubscriptionRoleResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "updateSubscriptionRole"
      summary: "Update a member's role in a room"
      description: "Updates the role(s) of a user in a chat room. The requesting user must have owner or moderator privileges in the room."
      tags: "Subscriptions"
    };
  }
  rpc SearchRoomSubscriptions(SearchRoomSubscriptionsRequest) returns (SearchRoomSubscriptionsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (gnostic.openapi.v3.operation) = {
      operation_id: "searchRoomSubscriptions"
      summary: "List room members"
      description: "Retrieves a paginated list of users subscribed to a room, along with their roles and activity information."
      tags: "Subscriptions"
    };
  }

  // Real-time Activity APIs
  // -----------------------------------------------------

  // Update different states that the client can be in for room subscriptions awareness
  rpc UpdateClientState(UpdateClientStateRequest) returns (UpdateClientStateResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "updateClientState"
      summary: "Update state from client"
      description: "Updates the state of an event in a specific room and optionally Broadcasts to all active participants."
      tags: "Real-time"
    };
  }

  // Get client state for a set of profiles in a room
  rpc GetClientState(GetClientStateRequest) returns (GetClientStateResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (gnostic.openapi.v3.operation) = {
      operation_id: "getClientStates"
      summary: "Get client states for profiles in a room"
      description: "Retrieves client states for profiles in a room showing either which messages users have read, or presence state of the users in a room."
      tags: "Real-time"
    };
  }
}

// -----------------------------------------------------
// Message RPCs (unified send + get history)
// -----------------------------------------------------

message SendEventRequest {
  repeated RoomEvent event = 4; // message payload (server will assign final event_id if empty)
}

message SendEventResponse {
  repeated EventAck ack = 1;
}

// History request: paging via opaque cursor. 'limit' is capped by server (e.g. 100).
// Ordering is determined by XID lexicographic order.
// Cursor encapsulates last seen event ID.
message GetHistoryRequest {
  string room_id = 2;
  common.v1.PageCursor cursor = 3;
  // direction: FORWARD means older -> newer; BACKWARD newer -> older (default BACKWARD).
  bool forward = 5;
}

message GetHistoryResponse {
  repeated RoomEvent events = 1;
  string next_cursor = 2; // opaque; empty when no more pages
  string prev_cursor = 3;
}

// -----------------------------------------------------
// Room APIs
// -----------------------------------------------------

message Room {
  string id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  string name = 3 [
    (buf.validate.field).string.min_len = 2,
    (buf.validate.field).string.max_len = 200
  ];
  string description = 4;
  bool is_private = 5;
  google.protobuf.Struct metadata = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
  string creator_id = 9;
}

message CreateRoomRequest {
  string id = 3 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ]; // optional client-provided idempotency key
  string name = 4 [
    (buf.validate.field).string.min_len = 2,
    (buf.validate.field).string.max_len = 200
  ];
  string description = 5;
  bool is_private = 6;
  repeated common.v1.ContactLink members = 7; // optional
  google.protobuf.Struct metadata = 8;
}

message CreateRoomResponse {
  Room room = 1;
  common.v1.ErrorDetail error = 2;
}

message SearchRoomsRequest {
  string query = 1;
  repeated string properties = 6;
  google.protobuf.Struct extras = 7;
  common.v1.PageCursor cursor = 10;
}

message SearchRoomsResponse {
  repeated Room data = 1;
}

message UpdateRoomRequest {
  string room_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  string name = 3;
  string topic = 4;
  google.protobuf.Struct metadata = 5;
}

message UpdateRoomResponse {
  Room room = 1;
  common.v1.ErrorDetail error = 2;
}

message DeleteRoomRequest {
  string room_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
}

message DeleteRoomResponse {
  string room_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  common.v1.ErrorDetail error = 2;
}

// -----------------------------------------------------
// Subscriptionship & roles
// -----------------------------------------------------

message RoomSubscription {
  // NOTE:
  // Event IDs are XIDs and MUST be lexicographically sortable by creation time.
  // Clients MUST NOT assume any other ordering mechanism.
  string id = 1 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  string room_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  common.v1.ContactLink member = 3;
  repeated string roles = 4; // e.g. ["owner","moderator","member","guest"]
  google.protobuf.Timestamp joined_at = 5;
  google.protobuf.Timestamp last_active = 6;
}

message AddRoomSubscriptionsRequest {
  string room_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  repeated RoomSubscription members = 3; // include roles if desired
}

message AddRoomSubscriptionsResponse {
  string room_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  common.v1.ErrorDetail error = 3;
}

message RemoveRoomSubscriptionsRequest {
  string room_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  repeated string subscription_id = 3;
}

message RemoveRoomSubscriptionsResponse {
  string room_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  common.v1.ErrorDetail error = 3;
}

message UpdateSubscriptionRoleRequest {
  string subscription_id = 3 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  string room_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];

  repeated string roles = 4;
}

message UpdateSubscriptionRoleResponse {
  string room_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  common.v1.ErrorDetail error = 3;
}

message SearchRoomSubscriptionsRequest {
  string room_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  common.v1.PageCursor cursor = 4;
}

message SearchRoomSubscriptionsResponse {
  string room_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  repeated RoomSubscription members = 2;
  string next_cursor = 3;
}

// -----------------------------------------------------
// Real-time Activity Request/Response Messages
// -----------------------------------------------------

message UpdateClientStateRequest {
  string room_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  common.v1.ContactLink source = 2;
  repeated ClientCommand client_states = 3;
}

message UpdateClientStateResponse {
  common.v1.ErrorDetail error = 1;
}

// GetClientState obtains the state of a set of profiles in a room
message GetClientStateRequest {
  string room_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,40}"
  ];
  repeated string subscription_id = 2;

  enum ClientStateType {
    CLIENT_STATE_TYPE_UNSPECIFIED = 0;
    CLIENT_STATE_TYPE_PRESENCE = 1;
    CLIENT_STATE_TYPE_READ_MARKER = 2;
  }
  ClientStateType state_type = 3;
}

message GetClientStateResponse {
  string room_id = 1;
  repeated ClientCommand client_state = 2;
}
