// Copyright 2023-2024 Ant Investor Ltd
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package device.v1;

// -----------------------------------------------------
// Core notes (normative):
// - Device Service manages device registration, tracking, and key/token management
// - All devices must be registered before use and linked to a profile
// - Supports device logs for session tracking and security auditing
// - KeyObject is used for all key types (FCM tokens, encryption keys, etc.)
// - All timestamps are RFC3339 / google.protobuf.Timestamp
// -----------------------------------------------------

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";
import "gnostic/openapi/v3/annotations.proto";

option go_package = "github.com/antinvestor/apis/go/device/v1;devicev1";
option java_multiple_files = true;
option java_package = "devicev1";

option (gnostic.openapi.v3.document) = {
  info: {
    title: "Device Management API";
    version: "v1.0.0";
    description: "The Device Management API provides comprehensive device management capabilities including device registration, session tracking, and unified key/token management. The API uses a unified KeyObject model for all key types including FCM tokens, encryption keys (Curve25519, Ed25519, Pickle), Matrix keys, and notification keys. This enables applications to register and track user devices across platforms (mobile, web, desktop), manage push notification tokens, handle encryption keys for secure communications, and maintain detailed logs of device activity for security and compliance purposes.";
    contact: {
      name: "Ant Investor Ltd";
      url: "https://github.com/antinvestor/service-device";
      email: "info@antinvestor.com";
    }
    license: {
      name: "Apache License";
      url: "https://github.com/antinvestor/apis/blob/master/LICENSE";
    }
  }
  components: {
    security_schemes: {
      additional_properties: [
        {
          name: "BearerAuth";
          value: {
            security_scheme: {
              type: "http";
              scheme: "bearer";
              bearer_format: "JWT";
            }
          }
        }
      ]
    }
  }
};

// -----------------------------------------------------
// Enumerations
// -----------------------------------------------------

// KeyType defines the types of keys that can be stored for a device.
// Different key types serve different purposes in the security infrastructure.
// buf:lint:ignore ENUM_VALUE_PREFIX
enum KeyType {
  // buf:lint:ignore ENUM_ZERO_VALUE_SUFFIX
  MATRIX_KEY = 0;        // Encryption key for Matrix protocol end-to-end encryption
  NOTIFICATION_KEY = 1;  // Key for secure push notification delivery
  FCM_TOKEN = 2;         // Firebase Cloud Messaging token for push notifications
  CURVE25519_KEY = 3;    // Curve25519 key for ECDH
  ED25519_KEY = 4;       // Ed25519 key for signing
  PICKLE_KEY = 5;        // Pickled key for session storage
}

// -----------------------------------------------------
// Core Data Types
// -----------------------------------------------------

// Locale represents the localization settings for a device.
// Used to provide localized content and format data appropriately for the user.
message Locale {
  repeated string language = 1;  // Preferred languages in priority order (e.g., ["en-US", "en"])
  string timezone = 5;            // IANA timezone identifier (e.g., "America/New_York")
  string utc_offset = 6;          // UTC offset in format "+HH:MM" or "-HH:MM"
  string currency = 8;            // ISO 4217 currency code (e.g., "USD", "EUR")
  string currency_name = 9;       // Human-readable currency name
  string code = 10;               // ISO 3166-1 alpha-2 country code (e.g., "US", "GB")
}

// KeyObject represents a key or token associated with a device.
// Keys are used for secure communications, authentication, and push notifications.
message KeyObject {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Unique identifier for the key
  string device_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device this key belongs to
  KeyType key_type = 3;               // Type of key (FCM token, encryption key, etc.)
  bytes key = 4;                      // The actual key material or token (encrypted at rest)
  string created_at = 5;              // Timestamp when key was created (RFC3339)
  string expires_at = 6;              // Optional expiration timestamp (RFC3339)
  bool is_active = 7;                 // Whether the key is currently active
  google.protobuf.Struct extra = 8;   // Additional key metadata (algorithm, app_id, etc.)
}

// DeviceLog represents an activity log entry for a device.
// Logs track device sessions, locations, and activity for security auditing.
message DeviceLog {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Unique identifier for this log entry
  string device_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device this log entry belongs to
  string session_id = 3;                // Session identifier for this activity
  string ip = 4;                        // IP address of the device during this session
  Locale locale = 5;                    // Locale settings during this session
  string user_agent = 6;                // User agent string (browser/app info)
  string os = 7;                        // Operating system and version
  string last_seen = 8;                 // Last activity timestamp (RFC3339)
  google.protobuf.Struct location = 9;  // Geographic location data (lat/long, city, country)
  google.protobuf.Struct extra = 10;    // Additional log metadata
}

// DeviceObject represents a registered device in the system.
// Devices must be registered and linked to a profile before use.
message DeviceObject {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Unique identifier for the device
  string name = 2;                        // User-friendly device name (e.g., "John's iPhone")
  string session_id = 3;                  // Current active session identifier
  string ip = 4;                          // Last known IP address
  string user_agent = 5;                  // User agent string
  string os = 6;                          // Operating system and version
  string last_seen = 7;                   // Last activity timestamp (RFC3339)
  string profile_id = 8;                  // Profile this device is linked to
  Locale locale = 9;                      // Device locale settings
  google.protobuf.Struct location = 11;   // Last known geographic location
  google.protobuf.Struct properties = 15; // Additional device properties (model, manufacturer, etc.)
}

// -----------------------------------------------------
// Device Management Messages
// -----------------------------------------------------

// GetByIdRequest retrieves one or more devices by their unique identifiers.
message GetByIdRequest {
  repeated string id = 1 [(buf.validate.field).repeated.items = {
    string: {
      min_len: 3
      max_len: 40
      pattern: "[0-9a-z_-]{3,20}"
    }
  }];  // List of device IDs to retrieve
  bool extensive = 2;  // If true, include additional details (logs, keys count, etc.)
}

// GetByIdResponse returns the requested devices.
message GetByIdResponse {
  repeated DeviceObject data = 1;  // List of devices matching the request
}

// GetBySessionIdRequest retrieves a device by its active session identifier.
message GetBySessionIdRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 3
    max_len: 40
    pattern: "[0-9a-z_-]{3,20}"
  }];  // Session ID to look up
}

// GetBySessionIdResponse returns the device associated with the session.
message GetBySessionIdResponse {
  DeviceObject data = 1;  // Device object for the session
}

// SearchRequest searches for devices matching specified criteria.
message SearchRequest {
  string query = 1;                     // Search query (device name, OS, etc.)
  int32 page = 2;                       // Page number for pagination
  int32 count = 3;                      // Number of results per page
  string start_date = 4;                // Filter devices created after this date (RFC3339)
  string end_date = 5;                  // Filter devices created before this date (RFC3339)
  repeated string properties = 6;       // Specific properties to include in results
  google.protobuf.Struct extras = 7;    // Additional search filters
}

// SearchResponse returns devices matching the search criteria.
message SearchResponse {
  repeated DeviceObject data = 1;  // List of matching devices
}

// CreateRequest registers a new device in the system.
message CreateRequest {
  string name = 2;                        // User-friendly name for the device
  google.protobuf.Struct properties = 3;  // Device properties (model, manufacturer, OS version, etc.)
}

// CreateResponse returns the newly created device.
message CreateResponse {
  DeviceObject data = 1;  // The created device object
}

// UpdateRequest updates an existing device's information.
message UpdateRequest {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device ID to update
  string name = 2;                        // New device name (if changing)
  google.protobuf.Struct properties = 3;  // Updated device properties
}

// UpdateResponse returns the updated device.
message UpdateResponse {
  DeviceObject data = 1;  // The updated device object
}

// LinkRequest links a device to a user profile.
// Devices must be linked before they can be used for authenticated operations.
message LinkRequest {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device ID to link
  string profile_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Profile ID to link the device to
  google.protobuf.Struct properties = 3;  // Additional linking properties
}

// LinkResponse returns the linked device.
message LinkResponse {
  DeviceObject data = 1;  // The linked device object
}

// RemoveRequest removes a device from the system.
// This is typically used when a user logs out or removes a device from their account.
message RemoveRequest {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device ID to remove
}

// RemoveResponse returns the removed device.
message RemoveResponse {
  DeviceObject data = 1;  // The removed device object
}

// -----------------------------------------------------
// Device Logging Messages
// -----------------------------------------------------

// LogRequest creates a new activity log entry for a device.
// Used for tracking device sessions and security auditing.
message LogRequest {
  string device_id = 1 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device ID (optional if session_id is provided)

  string session_id = 3 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Session identifier for this activity

  string ip = 4;                        // IP address of the device
  string locale = 5;                    // Locale settings (JSON string)
  string user_agent = 6;                // User agent string
  string os = 7;                        // Operating system and version
  string last_seen = 8;                 // Timestamp of this activity (RFC3339)
  google.protobuf.Struct extras = 9;    // Additional log data (location, app version, etc.)
}

// LogResponse returns the created log entry.
message LogResponse {
  DeviceLog data = 1;  // The created log entry
}

// ListLogsRequest retrieves activity logs for a device.
// Useful for security auditing and tracking device usage patterns.
message ListLogsRequest {
  string device_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device ID to retrieve logs for
  int32 count = 2;  // Maximum number of log entries to return
}

// ListLogsResponse returns device activity logs.
message ListLogsResponse {
  repeated DeviceLog data = 1;  // List of log entries
}

// -----------------------------------------------------
// Key Management Messages
// -----------------------------------------------------

// AddKeyRequest adds a key or token to a device.
// Keys are used for secure communications (Matrix E2EE, push notifications, FCM tokens, etc.).
message AddKeyRequest {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Unique identifier for the key
  string device_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device this key belongs to
  KeyType key_type = 3;                 // Type of key (Matrix, FCM, Encryption, etc.)
  bytes data = 4;                       // The key material or token (will be encrypted at rest)
  string expires_at = 5;                // Optional expiration timestamp (RFC3339)
  google.protobuf.Struct extras = 6;    // Additional key metadata (algorithm, app_id, etc.)
}

// AddKeyResponse returns the created key.
message AddKeyResponse {
  KeyObject data = 1;  // The created key object
}

// RemoveKeyRequest removes one or more keys or tokens from a device.
// Used when rotating keys, removing tokens, or removing a device.
message RemoveKeyRequest {
  repeated string id = 1 [(buf.validate.field).repeated.items = {
    string: {
      min_len: 3
      max_len: 40
      pattern: "[0-9a-z_-]{3,20}"
    }
  }];  // List of key IDs to remove
}

// RemoveKeyResponse returns the IDs of removed keys.
message RemoveKeyResponse {
  repeated string id = 1;  // List of removed key IDs
}

// SearchKeyRequest searches for keys or tokens associated with a device.
message SearchKeyRequest {
  string query = 1;       // Search query (key ID pattern, etc.)
  string device_id = 2 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device ID to search keys for
  repeated KeyType key_types = 3;  // Filter by key types (if empty, returns all)
  bool include_expired = 4;        // If true, includes expired keys
  int32 page = 5;                  // Page number for pagination
  int32 count = 6;                 // Number of results per page
}

// SearchKeyResponse returns matching keys or tokens.
message SearchKeyResponse {
  repeated KeyObject data = 1;  // List of matching keys
}

// -----------------------------------------------------
// Registration Messages (for third-party integration)
// -----------------------------------------------------

// RegisterKeyRequest registers a device with third-party services.
// Used when the key/token is generated by the third-party service (e.g., FCM token
// generated on device by FCM SDK). This links the device to the external service.
// For storing key material, use AddKeyRequest instead.
message RegisterKeyRequest {
  string device_id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Device to register with the service
  KeyType key_type = 2;  // Type of service to register with (FCM_TOKEN, etc.)
  google.protobuf.Struct extras = 3;  // Service-specific metadata (app_id, platform, etc.)
}

// RegisterKeyResponse returns confirmation of registration.
// The actual key/token data is managed by the third-party service.
message RegisterKeyResponse {
  KeyObject data = 1;  // Registered key object with service metadata
}

// DeRegisterKeyRequest removes device registration from third-party services.
// This cleans up the connection with external services like FCM.
message DeRegisterKeyRequest {
  string id = 1 [
    (buf.validate.field).string.min_len = 3,
    (buf.validate.field).string.max_len = 40,
    (buf.validate.field).string.pattern = "[0-9a-z_-]{3,20}"
  ];  // Key ID to deregister from external service
}

// DeRegisterKeyResponse confirms service deregistration.
message DeRegisterKeyResponse {
  bool success = 1;  // True if successfully deregistered from service
  string message = 2;  // Status message from the external service
}


// -----------------------------------------------------
// Service Definitions
// -----------------------------------------------------

// DeviceService provides core device management and key/token management.
// All RPCs require authentication via Bearer token unless otherwise specified.
service DeviceService {
  // GetById retrieves one or more devices by their unique identifiers.
  // Supports batch retrieval for efficiency.
  rpc GetById(GetByIdRequest) returns (GetByIdResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "getDeviceById"
      summary: "Get devices by ID"
      description: "Retrieves one or more devices by their unique identifiers. Supports batch retrieval and optional extensive details including logs and key counts."
      tags: "Devices"
    };
  }

  // GetBySessionId retrieves a device by its active session identifier.
  // Useful for resolving devices from session tokens.
  rpc GetBySessionId(GetBySessionIdRequest) returns (GetBySessionIdResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "getDeviceBySessionId"
      summary: "Get device by session ID"
      description: "Retrieves a device by its active session identifier. Used to resolve device information from session tokens."
      tags: "Devices"
    };
  }

  // Search finds devices matching specified criteria.
  // Supports filtering by date range, properties, and full-text search.
  rpc Search(SearchRequest) returns (stream SearchResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "searchDevices"
      summary: "Search devices"
      description: "Searches for devices matching specified criteria including device name, OS, date range, and custom properties. Returns a stream of matching devices."
      tags: "Devices"
    };
  }

  // Create registers a new device in the system.
  // Returns a unique device ID that should be stored by the client.
  rpc Create(CreateRequest) returns (CreateResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "createDevice"
      summary: "Register a new device"
      description: "Registers a new device in the system. The device must be linked to a profile before it can be used for authenticated operations."
      tags: "Devices"
    };
  }

  // Update modifies an existing device's information.
  // Only the device owner or administrators can update device information.
  rpc Update(UpdateRequest) returns (UpdateResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "updateDevice"
      summary: "Update device information"
      description: "Updates an existing device's name and properties. Only the device owner or administrators can perform this operation."
      tags: "Devices"
    };
  }

  // Link associates a device with a user profile.
  // Required before the device can be used for authenticated operations.
  rpc Link(LinkRequest) returns (LinkResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "linkDevice"
      summary: "Link device to profile"
      description: "Links a device to a user profile. This operation is required before the device can be used for authenticated operations."
      tags: "Devices"
    };
  }

  // Remove deletes a device from the system.
  // This operation cannot be undone.
  rpc Remove(RemoveRequest) returns (RemoveResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "removeDevice"
      summary: "Remove a device"
      description: "Removes a device from the system. This operation is typically used when a user logs out or removes a device from their account. This action cannot be undone."
      tags: "Devices"
    };
  }

  // Log creates a new activity log entry for a device.
  // Used for session tracking and security auditing.
  rpc Log(LogRequest) returns (LogResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "logDeviceActivity"
      summary: "Log device activity"
      description: "Creates a new activity log entry for a device. Used for tracking device sessions, locations, and activity for security auditing and compliance."
      tags: "Device Logs"
    };
  }

  // ListLogs retrieves activity logs for a device.
  // Returns a stream of log entries for the specified device.
  rpc ListLogs(ListLogsRequest) returns (stream ListLogsResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "listDeviceLogs"
      summary: "List device activity logs"
      description: "Retrieves activity logs for a device. Useful for security auditing, tracking device usage patterns, and compliance reporting."
      tags: "Device Logs"
    };
  }

  // AddKey adds a key or token to a device (FCM tokens, encryption keys, etc.).
  rpc AddKey(AddKeyRequest) returns (AddKeyResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "addDeviceKey"
      summary: "Add key or token"
      description: "Adds a key or token to a device. Supports FCM tokens, encryption keys (Curve25519, Ed25519), and other key types."
      tags: "Device Keys"
    };
  }

  // RemoveKey removes keys or tokens from a device.
  rpc RemoveKey(RemoveKeyRequest) returns (RemoveKeyResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "removeDeviceKey"
      summary: "Remove keys or tokens"
      description: "Removes one or more keys or tokens from a device. Used for key rotation, token management, or when removing a device."
      tags: "Device Keys"
    };
  }

  // SearchKey searches for keys or tokens associated with a device.
  rpc SearchKey(SearchKeyRequest) returns (SearchKeyResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "searchDeviceKey"
      summary: "Search keys or tokens"
      description: "Searches for keys or tokens associated with a device. Supports filtering by key type and expiration."
      tags: "Device Keys"
    };
  }

  // RegisterKey registers a key with third-party services (e.g., FCM, APNs).
  // This handles integration with external services and stores the key.
  rpc RegisterKey(RegisterKeyRequest) returns (RegisterKeyResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "registerKey"
      summary: "Register key with third-party service"
      description: "Registers a key or token with third-party services (like FCM for push notifications) and stores it. This method handles both the external service integration and local storage."
      tags: "Key Registration"
    };
  }

  // DeRegisterKey deregisters a key from third-party services.
  // This handles cleanup with external services and removes the key.
  rpc DeRegisterKey(DeRegisterKeyRequest) returns (DeRegisterKeyResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "deRegisterKey"
      summary: "DeRegister key from third-party service"
      description: "DeRegisters a key or token from third-party services (like FCM) and removes it from storage. This method handles both the external service cleanup and local deletion."
      tags: "Key Registration"
    };
  }

  // RegisterNotificationKey registers a notification key for push notifications.
  // This integrates with notification services and stores the key.
  rpc RegisterNotificationKey(RegisterKeyRequest) returns (RegisterKeyResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "registerNotificationKey"
      summary: "Register notification key"
      description: "Registers a notification key for secure push notification delivery. This method integrates with notification services (APNs, FCM) and stores the key."
      tags: "Notification Keys"
    };
  }

  // DeRegisterNotificationKey deregisters a notification key.
  // This removes the key from notification services and local storage.
  rpc DeRegisterNotificationKey(DeRegisterKeyRequest) returns (DeRegisterKeyResponse) {
    option (gnostic.openapi.v3.operation) = {
      operation_id: "deRegisterNotificationKey"
      summary: "DeRegister notification key"
      description: "DeRegisters a notification key from notification services and removes it from storage. Used when disabling push notifications."
      tags: "Notification Keys"
    };
  }
}
